name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate Prisma Client
      run: npx prisma generate --no-engine
      
    - name: TypeScript Type Check
      id: typecheck
      run: npm run typecheck 2>&1 | tee typecheck.log || echo "typecheck_failed=true" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: ESLint Check
      id: lint
      run: npm run lint 2>&1 | tee lint.log || echo "lint_failed=true" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: Run Tests
      id: test
      run: npm run test 2>&1 | tee test.log || echo "test_failed=true" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: Check for TODO/FIXME comments
      run: |
        if grep -r "TODO\|FIXME" --include="*.ts" --include="*.js" .; then
          echo "⚠️  Found TODO/FIXME comments in code"
          grep -rn "TODO\|FIXME" --include="*.ts" --include="*.js" . || true
        else
          echo "✅ No TODO/FIXME comments found"
        fi
        
    - name: Check for console.log statements
      run: |
        if grep -r "console\." --include="*.ts" --include="*.js" --exclude-dir=node_modules .; then
          echo "⚠️  Found console statements in code"
          grep -rn "console\." --include="*.ts" --include="*.js" --exclude-dir=node_modules . || true
          exit 1
        else
          echo "✅ No console statements found"
        fi
        
    - name: Analyze Errors with Claude and Create Issues
      if: failure()
      uses: anthropics/claude-github-action@v1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        prompt: |
          You are analyzing CI/CD errors for a TypeScript/Node.js project. The following errors occurred:
          
          TYPECHECK ERRORS:
          $(cat typecheck.log 2>/dev/null || echo "No typecheck errors")
          
          LINT ERRORS:
          $(cat lint.log 2>/dev/null || echo "No lint errors")
          
          TEST ERRORS:
          $(cat test.log 2>/dev/null || echo "No test errors")
          
          Please create GitHub issues for these errors. For each category of errors:
          1. Group related errors together
          2. Provide root cause analysis
          3. Give step-by-step fix instructions
          4. Include code examples where helpful
          5. Set appropriate priority (high for blocking errors)
          
          Create issues with descriptive titles like "Fix missing dependencies" or "Resolve TypeScript strict mode errors".
        create-issues: true
        issue-labels: bug,ci,automated